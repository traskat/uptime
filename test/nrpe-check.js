var raw = require('raw-socket');
var net = require('net');
var struct = require('ref-struct');
var ref = require('ref');
//var _ = require('struct-fu');
var _ = require('c-struct');
var checksum = require('crc32');


var packet = new _.Schema({
	version: _.type.uint16,
	type: _.type.uint16,
	crc: _.type.uint32,
	result: _.type.uint16,
	data: _.type.string()
});


console.log(packet);

var myStr = 'check_users';
while (myStr.length<1024) {
	myStr+= '\0';
};

console.log('++++++##################', myStr.length);




var unpacked = {
	version: 2,
	type: 1,
	crc: '\x00\x00\x00\x00',
	result: 0,
	data: myStr
};

_.register('packet', packet);


var packed = _.packSync('packet', unpacked);


/*
unpacked.crc = checksum(packed, true);
_.register('rawPacket', unpacked);
var buf =  _.packSync('rawPacket', unpacked);
*/
//var p = _.packSync(buf);

var crc = new Buffer(checksum(packed, true),'hex').readUInt16BE(0);
console.log('##',crc);


console.log(packed.toString('hex'));//, unpacked, packed);

packed.writeUInt16BE(crc, 8);
console.log(packed.toString('hex'));//, unpacked, packed);

var buf = packed;
//console.log(buf);


/*var version = ref.alloc('uint16');

ref.writeUInt16BE(version,0,2);

console.log(version);

console.log(ref.readUInt16BE(version));

var packet = struct({
		
});*/



/*
var socket = raw.createSocket({protocol: raw.Protocol.TCP, generateChecksum:true});

var buf = new Buffer(['65432'.toString('hex'),
					  '5666'.toString('hex'),
					  '1'.toString('hex'),
					  ]);


console.log('Buffer', buf.toString());
socket.send(buf, 0, buf.length, '188.40.61.216', function(error,bytes) {
	console.log(error,bytes);
});*/



var opts = {
	readable: true,
	writeable: true
}

var s = new net.Socket (opts);

var con = s.connect('5666', '188.40.61.216');

//var packet = [2,1,'check_load'].toString(2);

//con.write(b);
// console.log(buf)
// con.write(buf);
// con.write(buf);
// con.write(buf);
// con.write(buf);
// con.write(buf+'\r\n');

var b = '00020001ce0fe8fe4e76636865636b5f757365727300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006e62';
buf = new Buffer(b,'hex');
con.on('connect', function() {
	console.log('Connected...');
	console.log('################',buf.toString('hex'), buf.length);

	con.write(buf);
	// var res = con.write(buf, function(val) {
	// 	console.log('VAL: ', val)
	// });

	con.on('data', function(data) {
		console.log('++++++++++++', data)
	})
	//console.log('RES: ', res);
})

con.on('data', function(data) {
	console.log('--------------data: ', data);
});

con.on('drain', function() {
	console.log('drain');
});

con.on('error', function(err) {
	console.log('error', err);
});